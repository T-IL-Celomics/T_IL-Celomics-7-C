````markdown
# TIFF Mask Overlay Evaluator

This script compares two folders of segmentation masks (as TIFF files) — typically **Imaris** masks (reference) and **Cell-ACDC** masks (predicted) — and computes pixel-level overlap metrics for every matching pair of files.

It outputs a CSV with **IoU**, **Dice**, and raw pixel counts per frame, so you can later rank segmentation runs or feed the results into an optimization step.

---

## Features

- Compares **two folders** of `.tif` / `.tiff` files.
- Ignores visualization files that end with `_green.tif` (those are display-only).
- Handles **RGB** masks from Imaris (red masks): automatically uses the red channel.
- Computes:
  - `iou` (Intersection over Union)
  - `dice` (Dice coefficient)
  - `intersection` (overlapping pixels)
  - `union` (pixels belonging to either mask)
  - `pred_pixels` (foreground pixels in Cell-ACDC mask)
  - `gt_pixels` (foreground pixels in Imaris mask)
- Writes one row **per frame** to a CSV.

---

## Requirements

- Python 3.7+
- [`tifffile`](https://pypi.org/project/tifffile/)
- `numpy`

Install:

```bash
pip install tifffile numpy
````

---

## Usage

```bash
python compute_overlay_batch.py /path/to/imaris_dir /path/to/cellacdc_dir -o overlay_results.csv
```

**Arguments:**

* `imaris_dir` – folder with Imaris masks (can be RGB, e.g. red masks).
* `cellacdc_dir` – folder with Cell-ACDC masks (the ones your exporter created, **not** the `_green.tif` visualization files).
* `-o / --out` – path to the output CSV (default: `overlay_results.csv`).

**Example:**

```bash
python compute_overlay_batch.py data/imaris_masks/ data/cellacdc_masks_aligned/ -o results/cellpose_v3_default.csv
```

---

## How it works

1. **Collect files**
   The script lists all `.tif` / `.tiff` files in each folder and sorts them.
   Files ending with `_green.tif` are **ignored** because those are RGB visualization images generated by the exporter.

2. **Pairing**
   Files are paired by sorted order: first Imaris file with first Cell-ACDC file, etc.
   If the two folders have different counts, the script compares only up to the shorter length and prints a warning.

3. **Loading & binarizing**

   * The TIFF is loaded with `tifffile.imread(...)`.
   * If the image is RGB (shape `(Y, X, 3)`), the script takes the **first channel** (red).
   * Any pixel `> 0` is treated as foreground (`True`), everything else is background.

4. **Shape check**
   If the two masks of a pair don’t have the exact same shape, the script:

   * prints a message like
     `SHAPE MISMATCH: (1024, 1024) vs (1004, 1024) -> ...`
   * still writes a row to the CSV (with empty IoU/Dice) so the file isn’t empty.

5. **Metrics**
   For pairs with matching shapes:

   * `intersection = sum( (pred == 1) & (gt == 1) )`
   * `union = sum( (pred == 1) | (gt == 1) )`
   * `iou = intersection / union`
   * `dice = 2 * intersection / (pred_pixels + gt_pixels)`

6. **CSV output**
   A CSV is written with the following columns:

   * `index` – pair index (0-based)
   * `imaris_file` – name of ground-truth file
   * `cellacdc_file` – name of predicted file
   * `iou`
   * `dice`
   * `intersection`
   * `union`
   * `pred_pixels`
   * `gt_pixels`

---

## Notes

* **Use the non-`_green` TIFFs** from the Cell-ACDC export for comparison.
  The `_green` images are RGB overlays for viewing in Fiji and are intentionally skipped.
* Make sure your Cell-ACDC TIFFs were exported with the same spatial size as the Imaris TIFFs (the script will tell you if not).
* You can run this script for every segmentation experiment (different algorithm/parameters) and save each CSV under a different name — later you can compare the mean IoU across runs.

---

## Example Output (CSV)

```csv
index,imaris_file,cellacdc_file,iou,dice,intersection,union,pred_pixels,gt_pixels
0,C1_M1006-nir_B2_1_T00_T00_2000.tif,field1_B2_optimize_try3_10000.tif,0.1203,0.2139,13934,113239,54083,73090
1,C1_M1006-nir_B2_1_T00_T01_2000.tif,field1_B2_optimize_try3_10001.tif,0.0915,0.1673,11784,128724,54803,77970
...
```

---

## Troubleshooting

* **CSV is empty / only header:**
  Most likely the Imaris and Cell-ACDC TIFFs have different shapes. Check the terminal messages for `SHAPE MISMATCH` and re-export the Cell-ACDC masks with the correct shift or cropping.

* **IoU is very low (0.1–0.2):**
  Script is still correct — this usually means the two segmentations don’t agree well yet (different algorithm, threshold, or small misalignment).

---

## License

Use and modify freely inside your analysis pipeline.

```
::contentReference[oaicite:0]{index=0}
```
